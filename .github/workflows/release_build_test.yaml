name: Release build test
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: "Memgraph Build type. Default value is Release."
        default: 'Release'
        options:
          - Release
          - RelWithDebInfo

  push:
    tags:
      - "v*.*.*-rc*"
      - "v*.*-rc*"
  schedule:
    # UTC
    - cron: "0 22 * * *"

jobs:
  Test:
    uses: ./.github/workflows/reusable_release_tests.yaml
    with:
      os: "debian-11"
      toolchain: "v5"
      arch: "amd"
      runner_arch_label: "X64"
      threads: 24
      build_type: ${{ github.event.inputs.build_type || 'Release' }}
    secrets: inherit

  Package:
    if: github.ref_type == 'tag'
    uses: ./.github/workflows/reusable_package.yaml
    with:
      os: "debian-11"
      toolchain: "v5"
      arch: "amd"
      runner_arch_label: "X64"
      build_type: ${{ github.event.inputs.build_type || 'Release' }}
      timeout_minutes: 60
      push_to_s3: 'true'
      s3_bucket: "download.memgraph.com"
      s3_region: "eu-west-1"
      s3_dest_dir: "memgraph-unofficial/${{ github.ref_name }}"
    secrets: inherit
