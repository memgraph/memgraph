name: "Diff (External)"
concurrency:
  group: ${{ github.head_ref || github.sha }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      pr_number:
        type: string
        required: true
        description: 'Pull Request number to create staging branch from'
      base_master:
        type: boolean
        default: false
        description: Create staging branch using master as base.
      community_core:
        type: boolean
        default: true
      coverage:
        description: 'Comma-separated list of coverage tests to run (e.g. core,clang_tidy). Use "none" to skip all coverage tests.'
        default: 'core,clang_tidy'
      debug_core:
        type: boolean
        default: true
      debug_integration:
        type: boolean
        default: true
      jepsen_core:
        type: boolean
        default: true
      release:
        description: 'Comma-separated list of release tests to run (e.g. core,benchmark,e2e,stress,query_modules). Use "none" to skip all release tests.'
        default: 'core,benchmark,e2e,stress,query_modules'
      malloc_build:
        type: boolean
        default: true

jobs:
  CallCreateStagingBranch:
    uses: ./.github/workflows/create_staging_branch.yaml
    with:
      pr_number: ${{ inputs.pr_number }}
      base_master: ${{ inputs.base_master }}
    secrets: inherit

  TriggerDiffWorkflow:
    needs: CallCreateStagingBranch
    uses: ./.github/workflows/diff.yaml
    with:
      community_core: ${{ inputs.community_core }}
      coverage: ${{ inputs.coverage }}
      debug_core: ${{ inputs.debug_core }}
      debug_integration: ${{ inputs.debug_integration }}
      jepsen_core: ${{ inputs.jepsen_core }}
      release: ${{ inputs.release }}
      malloc_build: ${{ inputs.malloc_build }}
      ref: ${{ needs.CallCreateStagingBranch.outputs.staging_branch }}
    secrets: inherit

  UpdatePRComment:
    continue-on-error: true  # NOTE: older branches may not have the code to create this comment
    needs: [CallCreateStagingBranch, TriggerDiffWorkflow]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update PR comment with diff results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ needs.TriggerDiffWorkflow.result }}" == "success" ]; then
            status="true"
            echo "✅ Diff workflow completed successfully"
          else
            status="false"
            echo "❌ Diff workflow failed"
          fi

          python3 ./tools/external-contributions/pr_comment_update.py \
            "${{ needs.CallCreateStagingBranch.outputs.comment_id }}" \
            "${{ github.event.inputs.pr_number }}" \
            "${{ needs.CallCreateStagingBranch.outputs.staging_branch }}" \
            "$status"
