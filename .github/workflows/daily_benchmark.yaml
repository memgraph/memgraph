name: Daily Benchmark

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

jobs:
  release_benchmarks:
    name: "Release benchmarks"
    runs-on: [self-hosted, Linux, X64, Diff, Gen7]
    timeout-minutes: 120
    env:
      ARCH: "amd"
      OS: "ubuntu-24.04"
      TOOLCHAIN: "v6"
      BUILD_TYPE: "Release"
      MEMGRAPH_ENTERPRISE_LICENSE: ${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}
      MEMGRAPH_ORGANIZATION_NAME: ${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}

    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Spin up mgbuild container
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          run

      - name: Build release binary
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --build-type $BUILD_TYPE \
          build-memgraph

      - name: Run macro benchmarks
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --enterprise-license $MEMGRAPH_ENTERPRISE_LICENSE \
          --organization-name $MEMGRAPH_ORGANIZATION_NAME \
          test-memgraph macro-benchmark

      - name: Get branch name
        shell: bash
        run: |
          if [[ ${{ github.event_name }} == 'pull_request' ]]; then
            echo "BRANCH_NAME=$(echo ${GITHUB_HEAD_REF} | tr / -)" >> $GITHUB_ENV
          else
            echo "BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr / -)" >> $GITHUB_ENV
          fi

      - name: Upload macro benchmark results
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --enterprise-license $MEMGRAPH_ENTERPRISE_LICENSE \
          --organization-name $MEMGRAPH_ORGANIZATION_NAME \
          test-memgraph upload-to-bench-graph \
          --benchmark-name "macro_benchmark" \
          --benchmark-results "../../tests/macro_benchmark/.harness_summary" \
          --github-run-id ${{ github.run_id }} \
          --github-run-number ${{ github.run_number }} \
          --head-branch-name ${{ env.BRANCH_NAME }}

      - name: Run mgbench
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --enterprise-license $MEMGRAPH_ENTERPRISE_LICENSE \
          --organization-name $MEMGRAPH_ORGANIZATION_NAME \
          test-memgraph mgbench

      - name: Upload mgbench results
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --enterprise-license $MEMGRAPH_ENTERPRISE_LICENSE \
          --organization-name $MEMGRAPH_ORGANIZATION_NAME \
          test-memgraph upload-to-bench-graph \
          --benchmark-name "mgbench" \
          --benchmark-results "../../tests/mgbench/benchmark_result.json" \
          --github-run-id "${{ github.run_id }}" \
          --github-run-number "${{ github.run_number }}" \
          --head-branch-name "${{ env.BRANCH_NAME }}"

      - name: Stop mgbuild container
        if: always()
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          stop --remove

      # # TODO(gitbuda): seems like only the first benchmark is actually run under the new release/package/mgbuild.sh above (add the rest).
      # - name: Run mgbench
      #   run: |
      #     cd tests/mgbench
      #     ./benchmark.py vendor-native --num-workers-for-benchmark 12 --export-results benchmark_pokec.json pokec/medium/*/*
      #     ./benchmark.py vendor-native --num-workers-for-benchmark 1 --export-results benchmark_supernode.json supernode
      #     ./benchmark.py vendor-native --num-workers-for-benchmark 1 --export-results benchmark_high_write_set_property.json high_write_set_property
      #     ./benchmark.py vendor-native --num-workers-for-benchmark 12 --export-results cartesian.json cartesian
      #
      # - name: Upload mgbench results
      #   run: |
      #     cd tools/bench-graph-client
      #     virtualenv -p python3 ve3
      #     source ve3/bin/activate
      #     pip install -r requirements.txt
      #     ./main.py --benchmark-name "mgbench" \
      #               --benchmark-results "../../tests/mgbench/benchmark_pokec.json" \
      #               --github-run-id "${{ github.run_id }}" \
      #               --github-run-number "${{ github.run_number }}" \
      #               --head-branch-name "${{ env.BRANCH_NAME }}"
      #
      #     ./main.py --benchmark-name "supernode" \
      #               --benchmark-results "../../tests/mgbench/benchmark_supernode.json" \
      #               --github-run-id "${{ github.run_id }}" \
      #               --github-run-number "${{ github.run_number }}" \
      #               --head-branch-name "${{ env.BRANCH_NAME }}"
      #
      #     ./main.py --benchmark-name "high_write_set_property" \
      #               --benchmark-results "../../tests/mgbench/benchmark_high_write_set_property.json" \
      #               --github-run-id "${{ github.run_id }}" \
      #               --github-run-number "${{ github.run_number }}" \
      #               --head-branch-name "${{ env.BRANCH_NAME }}"
      #
      #     ./main.py --benchmark-name "cartesian" \
      #               --benchmark-results "../../tests/mgbench/cartesian.json" \
      #               --github-run-id "${{ github.run_id }}" \
      #               --github-run-number "${{ github.run_number }}" \
      #               --head-branch-name "${{ env.BRANCH_NAME }}"
