name: Daily Benchmark

on:
  workflow_dispatch:
    inputs:
      loop_count:
        type: number
        description: "Number of times to run the benchmarks. Default is 10."
        default: 10
  schedule:
    - cron: "0 1 * * *"

jobs:
  release_benchmarks:
    name: "Release benchmarks"
    runs-on: [self-hosted, Linux, X64, "${{ github.ref == 'refs/heads/master' && 'benchmark' || 'x86-64-v3' }}"]
    timeout-minutes: 330
    #  The timeout above is calculated based on a previous run where the loop count was 100
    #  Rough times per test:
    #  - macro-benchmark: 2.13 minutes
    #  - mgbench: 13 minutes
    #  - extended planner improvements mgbench: 7.26 minutes
    #  - mgbench-supernode: 1 minute (very rough estimate)
    #  10 iterations would take about 234 minutes, leaving 36 minutes to allow
    #  for building memgraph and variations in benchmark times.
    env:
      ARCH: "amd"
      OS: "ubuntu-24.04"
      TOOLCHAIN: "v7"
      BUILD_TYPE: "Release"
      MEMGRAPH_ENTERPRISE_LICENSE: ${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}
      MEMGRAPH_ORGANIZATION_NAME: ${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}
      DEFAULT_MGBENCH_EXPORT_RESULTS_FILE: 'benchmark_result.json'
      LOOP_COUNT: ${{ inputs.loop_count || 10 }}

    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to Docker Hub
        uses: ./.github/actions/docker-login
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Spin up mgbuild container
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          run

      - name: Build release binary
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          --build-type $BUILD_TYPE \
          build-memgraph

      - name: Initialize tests
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          init-tests

      - name: Get branch name
        shell: bash
        run: |
          if [[ ${{ github.event_name }} == 'pull_request' ]]; then
            echo "BRANCH_NAME=$(echo ${GITHUB_HEAD_REF} | tr / -)" >> $GITHUB_ENV
          else
            echo "BRANCH_NAME=$(echo ${GITHUB_REF#refs/heads/} | tr / -)" >> $GITHUB_ENV
          fi

      - name: Run and upload macro benchmarks
        id: macro-benchmark
        continue-on-error: true
        run: |
          ./tools/loop-benchmark.sh \
            macro-benchmark \
            macro_benchmark \
            .harness_summary \
            ${{ github.run_id }} \
            ${{ github.run_number }} \
            $BRANCH_NAME \
            macro_benchmark

      - name: Run and upload mgbench-supernode
        id: mgbench-supernode
        continue-on-error: true
        run: |
          ./tools/loop-benchmark.sh \
            mgbench-supernode \
            supernode \
            ${{ env.DEFAULT_MGBENCH_EXPORT_RESULTS_FILE }} \
            ${{ github.run_id }} \
            ${{ github.run_number }} \
            $BRANCH_NAME \
            mgbench

      - name: Run and upload mgbench
        id: mgbench
        continue-on-error: true
        run: |
          ./tools/loop-benchmark.sh \
            mgbench \
            mgbench \
            ${{ env.DEFAULT_MGBENCH_EXPORT_RESULTS_FILE }} \
            ${{ github.run_id }} \
            ${{ github.run_number }} \
            $BRANCH_NAME \
            mgbench

      - name: Run extended planner optimizations mgbench
        id: planner
        continue-on-error: true
        run: |
          ./tools/loop-benchmark.sh \
            "mgbench --dataset pokec_planner_optimizations --size medium" \
            mgbench-planner-optimizations \
            benchmark_result_extended.json \
            ${{ github.run_id }} \
            ${{ github.run_number }} \
            $BRANCH_NAME \
            mgbench

      - name: Stop mgbuild container
        if: always()
        run: |
          ./release/package/mgbuild.sh \
          --toolchain $TOOLCHAIN \
          --os $OS \
          --arch $ARCH \
          stop --remove

      - name: Clean up Docker
        if: always()
        continue-on-error: true
        run: |
          ./tools/docker_cleanup.sh

      - name: Trigger Regression Detection Job
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/memgraph/infra/dispatches \
            -d "{\"event_type\": \"regression-detection\"}"

      - name: Set Job Status
        run: |
          success=${{ steps.macro-benchmark.outcome == 'success' && steps.mgbench-supernode.outcome == 'success' && steps.mgbench.outcome == 'success' && steps.planner.outcome == 'success' }}
          echo "success=$success" >> $GITHUB_OUTPUT
          if [ "$success" == "true" ]; then
            echo "All benchmarks succeeded"
          else
            echo "Some benchmarks failed"
            exit 1
          fi
