name: Package All

# TODO(gitbuda): Cleanup docker container if GHA job was canceled.

on:
  workflow_dispatch:
    inputs:
      memgraph_version:
        description: "Memgraph version to upload as. If empty upload is skipped. Format: 'vX.Y.Z'"
        required: false

jobs:
  centos-7:
    runs-on: [self-hosted, DockerMgBuild, X64]
    timeout-minutes: 60
    steps:
      - name: "Set up repository"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Required because of release/get_version.py
      - name: "Build package"
        run: |
          ./release/package/run.sh package centos-7
      - name: "Upload package"
        uses: actions/upload-artifact@v3
        with:
          name: centos-7
          path: build/output/centos-7/memgraph*.rpm

  upload-to-s3:
    # only run upload if we specified version. Allows for runs without upload
    if: "${{ github.event.inputs.memgraph_version != '' }}"
    needs: centos-7
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          # name: # if name input parameter is not provided, all artifacts are downloaded
                  # and put in directories named after each one.
          path: build/output/release
      - name: Get release version
        run: |
          echo "RELEASE_VERSION=${{ github.event.inputs.memgraph_version }}"
      - name: Upload to S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        env:
          AWS_S3_BUCKET: "download.memgraph.com"
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: "eu-west-1"
          SOURCE_DIR: "build/output/release"
          DEST_DIR: "memgraph/release/${{ env.RELEASE_VERSION  }}/"
