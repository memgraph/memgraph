name: Stress tests docker HA
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches:
      - stress_tests_provisioned
  workflow_dispatch:
    inputs:
      memgraph_image:
        type: string
        description: "Memgraph Docker image (repo:tag or URL to .tar.gz)"
        default: 'memgraph/memgraph:latest'

env:
  MEMGRAPH_ENTERPRISE_LICENSE: ${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}
  MEMGRAPH_ORGANIZATION_NAME: ${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}

jobs:
  stress_tests_docker_ha:
    name: "Stress tests docker HA"
    runs-on: [self-hosted, X64]
    timeout-minutes: 180

    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to Docker Hub
        uses: ./.github/actions/docker-login
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine Input Type
        run: |
          INPUT_IMAGE="${{ inputs.memgraph_image || 'memgraph/memgraph:latest' }}"
          read image_type image_value < <(python3 tools/issu_image_type.py "$INPUT_IMAGE")
          echo "IMAGE_TYPE=${image_type}" >> $GITHUB_ENV
          echo "IMAGE_VALUE=${image_value}" >> $GITHUB_ENV

      - name: Load Image (Docker)
        if: ${{ env.IMAGE_TYPE == 'docker' }}
        run: |
          docker pull "$IMAGE_VALUE"
          echo "MEMGRAPH_IMAGE=${{ env.IMAGE_VALUE }}" >> $GITHUB_ENV

      - name: Load Image (URL)
        if: ${{ env.IMAGE_TYPE == 'url' }}
        run: |
          curl -L ${{ env.IMAGE_VALUE }} > memgraph.tar.gz
          load_output=$(docker load -i memgraph.tar.gz)

          # grab each repo:tag, drop the ":latest" one, pick the first real tag
          repo_tag=$(echo "$load_output" \
            | awk -F': ' '/Loaded image:/ {print $2}' \
            | grep -v ':latest$' \
            | head -n1)

          echo "MEMGRAPH_IMAGE=${repo_tag}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m venv tests/ve3
          source tests/ve3/bin/activate
          pip install --upgrade pip
          pip install -r tests/stress/requirements.txt

      - name: Run stress tests (docker HA)
        run: |
          source tests/ve3/bin/activate
          export MEMGRAPH_ENTERPRISE_LICENSE="${MEMGRAPH_ENTERPRISE_LICENSE}"
          export MEMGRAPH_ORGANIZATION_NAME="${MEMGRAPH_ORGANIZATION_NAME}"
          export MEMGRAPH_IMAGE="${MEMGRAPH_IMAGE}"
          cd tests/stress
          ./continuous_integration --deployment docker_ha
        env:
          MEMGRAPH_IMAGE: ${{ env.MEMGRAPH_IMAGE }}
          MEMGRAPH_ENTERPRISE_LICENSE: ${{ secrets.MEMGRAPH_ENTERPRISE_LICENSE }}
          MEMGRAPH_ORGANIZATION_NAME: ${{ secrets.MEMGRAPH_ORGANIZATION_NAME }}

      - name: Save stress test logs
        continue-on-error: true
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: "Stress Tests Docker HA Logs"
          path: tests/stress/**/*.log

      - name: Clean up Docker
        if: always()
        run: |
          ./tools/docker_cleanup.sh
