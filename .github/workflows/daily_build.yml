
name: Daily build and test
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  schedule:
    - cron: "0 22 * * *" #UTC
  workflow_dispatch:
    inputs:
      build_date:
        type: string
        description: "Specify build date (YYYYMMDD)"
        required: false
      skip_tests:
        type: boolean
        description: "Skip tests"
        default: false
      skip_package:
        type: boolean
        description: "Skip packaging"
        default: false
      skip_docker_artifact:
        type: boolean
        description: "Skip Docker artifact"
        default: false
      skip_issu_tests:
        type: boolean
        description: "Skip ISSU tests"
        default: false
      skip_mage:
        type: boolean
        description: "Skip MAGE build"
        default: false
      skip_smoke_tests:
        type: boolean
        description: "Skip smoke tests"
        default: false
      skip_stress_tests:
        type: boolean
        description: "Skip stress tests"
        default: false
      mock:
        type: boolean
        description: "Mock build"
        default: true
      run_cve_scan:
        type: boolean
        description: "Run CVE scan"
        default: true
jobs:
  # this job is used to get the current date at the time when the job is first triggered
  # so that the daily build is sent to the right folder!
  # (we may cross over midnight during build/test)
  CurrentDateJob:
    runs-on: [ubuntu-latest]
    outputs:
      current_date: ${{ steps.set_date.outputs.current_date }}
      is_sunday: ${{ steps.sunday.outputs.IS_SUNDAY }}
    steps:
      - name: Get current date
        id: set_date
        run: |
          if [[ ${{ github.event_name }} == 'workflow_dispatch' && -n "${{ github.event.inputs.build_date }}" ]]; then
            current_date="${{ github.event.inputs.build_date }}"
          else
            current_date=$(date -u +'%Y%m%d')
          fi
          echo "Current date is: $current_date"
          echo "current_date=$current_date" >> $GITHUB_OUTPUT

      - name: Is today Sunday? ðŸ¤”
        id: sunday
        run: |
          day="$(date -u +%A)"
          if [[ "$day" == "Sunday" ]]; then
            echo "IS_SUNDAY=true" >> $GITHUB_OUTPUT
          else
            echo "IS_SUNDAY=false" >> $GITHUB_OUTPUT
          fi


  TestBuild:
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_tests) }}
    uses: ./.github/workflows/reusable_release_tests.yaml
    with:
      os: 'ubuntu-24.04'
      arch: amd
      threads: 24
      build_type: 'Release'
      run_release_tests: 'true'
      run_stress_large: 'true'
    secrets: inherit

  DailyPackageArtifact:
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_package)  }}
    needs: [CurrentDateJob]
    strategy:
      fail-fast: false
      matrix:
        os: [centos-9, centos-10, debian-12, debian-13, fedora-42, rocky-10, ubuntu-22.04, ubuntu-24.04]
        arch: [amd]
        build_type: [Release]
        additional_build_args: ['']
        include: # Additional matrix entries for arm builds and RelWithDebInfo
          - os: debian-12
            build_type: Release
            arch: arm
            additional_build_args: ''
          - os: debian-13
            build_type: Release
            arch: arm
            additional_build_args: ''
          - os: fedora-42
            build_type: Release
            arch: arm
            additional_build_args: ''
          - os: ubuntu-24.04
            build_type: Release
            arch: arm
            additional_build_args: ''
          - os: ubuntu-24.04
            build_type: Release
            arch: amd
            additional_build_args: '--disable-jemalloc'
          - os: ubuntu-24.04
            build_type: RelWithDebInfo
            arch: arm
            additional_build_args: ''
          - os: ubuntu-24.04
            build_type: RelWithDebInfo
            arch: amd
            additional_build_args: ''
          - os: ubuntu-24.04
            build_type: RelWithDebInfo
            arch: amd
            additional_build_args: '--disable-jemalloc'
          - os: ubuntu-24.04
            build_type: RelWithDebInfo
            arch: arm
            additional_build_args: '--disable-jemalloc'
    uses: ./.github/workflows/reusable_package.yaml
    with:
      os: ${{ matrix.os }}
      arch: ${{ matrix.arch }}
      build_type: ${{ matrix.build_type }}
      push_to_github: 'false'
      push_to_s3: 'true'
      s3_bucket: deps.memgraph.io
      s3_region: eu-west-1
      s3_dest_dir: "daily-build/memgraph${{ inputs.mock && '_mock' || '' }}/${{ needs.CurrentDateJob.outputs.current_date }}"
      additional_build_args: ${{ matrix.additional_build_args }}
      run_smoke_tests: false
    secrets: inherit

  DailyDockerArtifact:
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_docker_artifact)  }}
    needs: [CurrentDateJob]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        arch: [amd, arm]
        build_type: [Release, RelWithDebInfo]
    uses: ./.github/workflows/reusable_package.yaml
    with:
      os: ${{ matrix.os }}
      arch: ${{ matrix.arch }}
      build_type: ${{ matrix.build_type }}
      additional_build_args: '--for-docker'
      push_to_github: 'false'
      push_to_s3: 'true'
      s3_bucket: deps.memgraph.io
      s3_region: eu-west-1
      s3_dest_dir: "daily-build/memgraph${{ inputs.mock && '_mock' || '' }}/${{ needs.CurrentDateJob.outputs.current_date }}"
      generate_sbom: ${{ (matrix.os == 'ubuntu-24.04' && matrix.build_type == 'Release' && matrix.arch == 'amd') && true || false }}
      run_smoke_tests: ${{ !inputs.skip_smoke_tests }}
    secrets: inherit

  AggregateBuildTests:
    if: ${{ (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_tests && !inputs.mock)) && always() }}
    needs: [CurrentDateJob,TestBuild,DailyPackageArtifact,DailyDockerArtifact]
    runs-on: [self-hosted]
    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Aggregate Test Results and Builds
        env:
          TEST_RESULT: ${{ needs.TestBuild.outputs.test_status }}
          CURRENT_BUILD_DATE: ${{ needs.CurrentDateJob.outputs.current_date }}
        run: |
          echo "TEST_RESULT: $TEST_RESULT"
          echo "Package Date: $CURRENT_BUILD_DATE"
          echo "BUILD_TEST_RESULTS=$(python3 tools/ci/aggregate_build_tests.py 'memgraph')" >> $GITHUB_ENV

      - name: Trigger Daily Builds Page Update
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          payload="${BUILD_TEST_RESULTS}"
          echo "Payload: $payload"
          # Send the dispatch request
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/memgraph/daily-builds/dispatches \
            -d "$payload"

  BuildAndTestMAGE:
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_mage) }}
    name: Build and Test MAGE
    needs: [CurrentDateJob]
    uses: ./.github/workflows/reusable_package_mage.yaml
    strategy:
      fail-fast: false
      matrix:
        build_type: ["Release", "RelWithDebInfo"]
        build_arch: ["amd", "arm"]
        malloc: [false]
        cuda: [false]
        cugraph: [false]
        include:
          - build_type: "Release"
            build_arch: "amd"
            malloc: true
            cuda: false
            cugraph: false
          - build_type: "RelWithDebInfo"
            build_arch: "amd"
            cuda: true
            malloc: false
            cugraph: false
          - build_type: "RelWithDebInfo"
            build_arch: "amd"
            cuda: false
            malloc: true
            cugraph: false
          - build_type: "RelWithDebInfo"
            build_arch: "arm"
            cuda: false
            malloc: true
            cugraph: false
          - build_type: "RelWithDebInfo"
            build_arch: "amd"
            cuda: false
            malloc: false
            cugraph: true
    with:
      arch: ${{ matrix.build_arch }}
      build_type: ${{ matrix.build_type }}
      s3_dest_dir: "daily-build/mage${{ inputs.mock && '_mock' || '' }}/${{ needs.CurrentDateJob.outputs.current_date }}"
      cuda: ${{ matrix.cuda }}
      cugraph: ${{ matrix.cugraph }}
      push_to_s3: true
      malloc: ${{ matrix.malloc }}
      run_smoke_tests: ${{ !matrix.cugraph && !inputs.skip_smoke_tests }}
      run_tests: true
      package_deb: "default"
      generate_sbom: ${{ matrix.build_arch == 'amd' && matrix.build_type == 'Release' && !matrix.malloc && !matrix.cuda && !matrix.cugraph }}
    secrets: inherit

  AggregateMAGEBuildTests:
    if: ${{ always() }}
    needs: [CurrentDateJob,BuildAndTestMAGE]
    runs-on: [self-hosted]
    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Aggregate Test Results and Builds
        env:
          TEST_RESULT: ${{ needs.BuildAndTestMAGE.result == 'success' && 'pass' || 'fail' }}
          CURRENT_BUILD_DATE: ${{ needs.CurrentDateJob.outputs.current_date }}
        run: |
          echo "TEST_RESULT: $TEST_RESULT"
          echo "Package Date: $CURRENT_BUILD_DATE"
          echo "BUILD_TEST_RESULTS=$(python3 tools/ci/aggregate_build_tests.py 'mage')" >> $GITHUB_ENV

      - name: Trigger Daily Builds Page Update
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.mock) }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          payload="${BUILD_TEST_RESULTS}"
          echo "Payload: $payload"
          # Send the dispatch request
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/memgraph/daily-builds/dispatches \
            -d "$payload"

  SetupDailyBuildImageOutputs:
    name: Setup Daily Build Image Outputs
    needs: [CurrentDateJob, DailyDockerArtifact, BuildAndTestMAGE]
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_issu_tests || !inputs.skip_stress_tests) }}
    runs-on: ubuntu-24.04
    outputs:
      amd_image_url: ${{ steps.set_image_urls.outputs.amd_image_url }}
      arm_image_url: ${{ steps.set_image_urls.outputs.arm_image_url }}
      amd_mage_image_url: ${{ steps.set_image_urls.outputs.amd_mage_image_url }}
      arm_mage_image_url: ${{ steps.set_image_urls.outputs.arm_mage_image_url }}
      last_image_version: ${{ steps.set_last_image_version.outputs.last_image_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AWS Login
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Set Image URLs
        id: set_image_urls
        env:
          MOCK: ${{ inputs.mock && 'true' || 'false' }}
        run: |
          echo "Setting next image URLs"
          export CURRENT_BUILD_DATE=${{ needs.CurrentDateJob.outputs.current_date }}
          read amd_image_url arm_image_url < <(python3 tools/ci/get_daily_build_images.py)
          echo "amd_image_url=$amd_image_url" >> $GITHUB_OUTPUT
          echo "arm_image_url=$arm_image_url" >> $GITHUB_OUTPUT
          echo "AMD Image URL: $amd_image_url"
          echo "ARM Image URL: $arm_image_url"
          read amd_mage_image_url arm_mage_image_url < <(python3 tools/ci/get_daily_build_images.py --type=mage)
          echo "amd_mage_image_url=$amd_mage_image_url" >> $GITHUB_OUTPUT
          echo "arm_mage_image_url=$arm_mage_image_url" >> $GITHUB_OUTPUT
          echo "AMD MAGE Image URL: $amd_mage_image_url"
          echo "ARM MAGE Image URL: $arm_mage_image_url"

      - name: Set last image version
        id: set_last_image_version
        run: |
          echo "Setting last image version"
          last_image_version=$(./tools/ci/get_latest_tag.sh)
          echo "last_image_version=$last_image_version" >> $GITHUB_OUTPUT

  RunISSUTest:
    name: Run ISSU Tests
    needs: [SetupDailyBuildImageOutputs]
    if: ${{ (github.event_name == 'schedule' && always() || (github.event_name == 'workflow_dispatch' && !inputs.skip_issu_tests)) && needs.SetupDailyBuildImageOutputs.result == 'success' }}
    uses: ./.github/workflows/reusable_issu_test.yaml
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd
            next_image: ${{ needs.SetupDailyBuildImageOutputs.outputs.amd_image_url }}
          - arch: arm
            next_image: ${{ needs.SetupDailyBuildImageOutputs.outputs.arm_image_url }}
    with:
      last_image: ${{ needs.SetupDailyBuildImageOutputs.outputs.last_image_version }}
      next_image: ${{ matrix.next_image }}
      arch: ${{ matrix.arch }}
    secrets: inherit

  TriggerCVEScan:
    name: Trigger CVE Scan
    needs: [CurrentDateJob, DailyDockerArtifact, BuildAndTestMAGE]
    if: ${{ (needs.CurrentDateJob.outputs.is_sunday == 'true' && github.event_name == 'schedule') || (github.event_name == 'workflow_dispatch' && inputs.run_cve_scan) }}
    uses: ./.github/workflows/cve_scan.yml
    with:
      date: "${{ needs.CurrentDateJob.outputs.current_date }}"
    secrets: inherit

  StressTestsNativeStandalone:
    name: "Stress Tests Native Standalone"
    needs: [DailyPackageArtifact]
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_stress_tests) }}
    uses: ./.github/workflows/reusable_stress_tests.yaml
    with:
      deployment: standalone/native
    secrets: inherit

  StressTestsNativeHA:
    name: "Stress Tests Native HA"
    needs: [DailyPackageArtifact]
    if: ${{ (github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_stress_tests) }}
    uses: ./.github/workflows/reusable_stress_tests.yaml
    with:
      deployment: ha/native
    secrets: inherit

  StressTestsDockerHA:
    name: "Stress Tests Docker HA"
    needs: [SetupDailyBuildImageOutputs]
    if: ${{ ((github.event_name == 'schedule' && always()) || (github.event_name == 'workflow_dispatch' && !inputs.skip_stress_tests)) && needs.SetupDailyBuildImageOutputs.result == 'success' }}
    uses: ./.github/workflows/reusable_stress_tests.yaml
    with:
      deployment: ha/docker
      memgraph_image: ${{ needs.SetupDailyBuildImageOutputs.outputs.amd_mage_image_url }}
    secrets: inherit
