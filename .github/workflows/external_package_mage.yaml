name: "Package mage (External)"

on:
  #push:
  workflow_dispatch:
    inputs:
      pr_number:
        type: string
        description: "PR number."
        default: ''
      base_master:
        type: boolean
        description: "Base master?"
        default: false
      build_arch:
        type: choice
        description: "Mage build architecture"
        default: 'amd'
        options:
          - "amd"
          - "arm"
      build_type:
        type: choice
        description: "Mage build type"
        default: 'Release'
        options:
          - "Release"
          - "RelWithDebInfo"
      memgraph_download_link:
        description: "Memgraph package download link. Leave empty to use the official download link."
        default: ""
        type: string
      cuda:
        type: boolean
        description: "Build the image for CUDA"
        default: false
      push_to_s3:
        type: boolean
        description: "Push the image to S3?"
        default: false
      s3_dest_dir:
        type: string
        description: "Destination directory in S3 bucket"
        default: "mage-unofficial"
      matrix_build:
        type: boolean
        description: "Enable multiple builds via a matrix configuration?"
        default: false
      malloc:
        type: boolean
        description: "Use malloc build of memgraph (no jemalloc)"
        default: false
      run_smoke_tests:
        type: boolean
        description: "Run smoke tests on images after building (tests against previous tagged image)"
        default: false


run-name: "Package MAGE"

jobs:
  CallCreateStagingBranch:
    uses: ./.github/workflows/create_staging_branch.yaml
    with:
      pr_number: ${{ inputs.pr_number }}
      base_master: ${{ inputs.base_master }}
    secrets: inherit

  TriggerPackageWorkflow:
    needs: CallCreateStagingBranch
    uses: ./.github/workflows/package_mage.yaml
    with:
      arch: ${{ inputs.build_arch }}
      build_type: ${{ inputs.build_type }}
      memgraph_download_link: ${{ inputs.memgraph_download_link }}
      cuda: ${{ inputs.cuda }}
      push_to_s3: ${{ inputs.push_to_s3 }}
      s3_dest_dir: ${{ inputs.s3_dest_dir }}
      matrix_build: ${{ inputs.matrix_build }}
      malloc: ${{ inputs.malloc }}
      run_smoke_tests: ${{ inputs.run_smoke_tests }}
      ref: ${{ needs.CallCreateStagingBranch.outputs.staging_branch }}
    secrets: inherit

  UpdatePRComment:
    continue-on-error: true  # NOTE: older branches may not have the code to create this comment
    needs: [CallCreateStagingBranch, TriggerPackageWorkflow]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update PR comment with package results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ needs.TriggerPackageWorkflow.result }}" == "success" ]; then
            status="true"
            echo "✅ Package workflow completed successfully"
          else
            status="false"
            echo "❌ Package workflow failed"
          fi

          python3 ./tools/ci/external-contributions/pr_comment_update.py \
            "${{ needs.CallCreateStagingBranch.outputs.comment_id }}" \
            "${{ github.event.inputs.pr_number }}" \
            "${{ needs.CallCreateStagingBranch.outputs.staging_branch }}" \
            "$status"

  CleanupStagingBranch:
    needs: [CallCreateStagingBranch, TriggerPackageWorkflow]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup staging branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./tools/ci/external-contributions/cleanup_staging_branch.sh \
          "${{ needs.CallCreateStagingBranch.outputs.staging_branch }}"
