name: "Post-PR Merge: Build and Upload MAGE Packages"

on:
  pull_request:
    types: [closed]
    branches:
      - master
  workflow_dispatch:
    inputs:
      pr_number:
        type: string
        description: "PR number to use for the build (e.g., 1234)"
        required: true

run-name: "Build and Upload Packages for PR merge"

jobs:
  get-pr-number:
    if: (github.event.pull_request.merged == true && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch'
    name: "Get PR Number"
    runs-on: [self-hosted, Linux, X64, DockerMgBuild]
    outputs:
      pr_number: ${{ steps.get_pr.outputs.pr_number }}
    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Number
        id: get_pr
        run: |
          # Get the PR number from the event or manual input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
            echo "Using manually provided PR number: $PR_NUMBER"
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
            echo "Using PR number from merged PR: $PR_NUMBER"
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR Number: $PR_NUMBER"

  build-packages-mage:
    if: (github.event.pull_request.merged == true && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch'
    name: "Build ${{ matrix.arch }} Package"
    needs: get-pr-number
    uses: ./.github/workflows/reusable_package_mage.yaml
    secrets: inherit
    strategy:
      matrix:
        arch: [amd, arm]
    with:
      arch: ${{ matrix.arch }}
      build_type: RelWithDebInfo
      push_to_s3: true
      s3_dest_dir: pr-build/mage/pr${{ needs.get-pr-number.outputs.pr_number }}
      ref: refs/heads/master
      print_output_url: true
