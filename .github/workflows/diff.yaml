name: "Diff"
concurrency:
  group: ${{ inputs.ref || github.head_ref || github.sha }}
  cancel-in-progress: true

on:
  merge_group:
  pull_request:
  workflow_dispatch:
    inputs:
      community_core:
        type: boolean
        default: true
      coverage:
        description: 'Comma-separated list of coverage tests to run (e.g. core,clang_tidy). Use "none" to skip all coverage tests.'
        default: 'core,clang_tidy'
      debug_core:
        type: boolean
        default: true
      debug_integration:
        type: boolean
        default: true
      jepsen_core:
        type: boolean
        default: true
      release:
        description: 'Comma-separated list of release tests to run (e.g. core,benchmark,e2e,stress,query_modules). Use "none" to skip all release tests.'
        default: 'core,benchmark,e2e,stress,query_modules'
      malloc_build:
        type: boolean
        default: true
      mage:
        type: string
        default: 'amd,arm,cuda'
        description: 'Comma-separated list of architectures to run the mage tests on (e.g. amd,arm,cuda). Use "none" to skip all mage tests.'
  workflow_call:
    inputs:
      community_core:
        type: boolean
        default: true
      coverage:
        description: 'Comma-separated list of coverage tests to run (e.g. core,clang_tidy). Use "none" to skip all coverage tests.'
        default: 'core,clang_tidy'
        type: string
      debug_core:
        type: boolean
        default: true
      debug_integration:
        type: boolean
        default: true
      jepsen_core:
        type: boolean
        default: true
      release:
        description: 'Comma-separated list of release tests to run (e.g. core,benchmark,e2e,stress,query_modules). Use "none" to skip all release tests.'
        default: 'core,benchmark,e2e,stress,query_modules'
        type: string
      malloc_build:
        type: boolean
        default: true
      mage:
        type: string
        default: 'amd,arm,cuda'
        description: 'Comma-separated list of architectures to run the mage tests on (e.g. amd,arm,cuda). Use "none" to skip all mage tests.'
      ref:
        description: 'Branch or commit ref to run the workflow on'
        required: false
        default: ''
        type: string

jobs:
  DiffSetup:
    runs-on: ubuntu-latest
    outputs:
      run_community_core: ${{ steps.setup.outputs.run_community_core }}
      run_coverage_core: ${{ steps.setup.outputs.run_coverage_core }}
      run_coverage_clang_tidy: ${{ steps.setup.outputs.run_coverage_clang_tidy }}
      run_debug_core: ${{ steps.setup.outputs.run_debug_core }}
      run_debug_integration: ${{ steps.setup.outputs.run_debug_integration }}
      run_jepsen_core: ${{ steps.setup.outputs.run_jepsen_core }}
      run_release_core: ${{ steps.setup.outputs.run_release_core }}
      run_release_benchmark: ${{ steps.setup.outputs.run_release_benchmark}}
      run_release_e2e: ${{ steps.setup.outputs.run_release_e2e }}
      run_release_stress: ${{ steps.setup.outputs.run_release_stress }}
      run_release_query_modules: ${{ steps.setup.outputs.run_release_query_modules }}
      run_malloc_build: ${{ steps.setup.outputs.run_malloc_build }}
      run_mage_amd: ${{ steps.setup.outputs.run_mage_amd }}
      run_mage_arm: ${{ steps.setup.outputs.run_mage_arm }}
      run_mage_cuda: ${{ steps.setup.outputs.run_mage_cuda }}
    env:
      GH_CONTEXT: ${{ toJson(github) }}
      GH_CONTEXT_FILE_NAME: github_context.json
    steps:
      - name: Set up repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0
      - name: Dump GitHub context
        run: echo "$GH_CONTEXT" >> "$GH_CONTEXT_FILE_NAME"
      - name: Set up diff execution
        id: setup
        run: ./tools/ci/diff_setup.py --gh-context-path "$GH_CONTEXT_FILE_NAME" --base-branch "origin/master"

  Community:
    needs: DiffSetup
    uses: ./.github/workflows/diff_community.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      arch: 'amd'
      os: 'ubuntu-24.04'
      run_core: ${{ needs.DiffSetup.outputs.run_community_core }}
    secrets: inherit

  Coverage:
    needs: DiffSetup
    uses: ./.github/workflows/diff_coverage.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      arch: 'amd'
      os: 'ubuntu-24.04'
      run_core: ${{ needs.DiffSetup.outputs.run_coverage_core }}
      run_clang_tidy: ${{ needs.DiffSetup.outputs.run_coverage_clang_tidy }}
    secrets: inherit

  Debug:
    needs: DiffSetup
    uses: ./.github/workflows/diff_debug.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      arch: 'amd'
      os: 'ubuntu-24.04'
      run_core: ${{ needs.DiffSetup.outputs.run_debug_core }}
      run_integration: ${{ needs.DiffSetup.outputs.run_debug_integration }}
    secrets: inherit

  Jepsen:
    needs: DiffSetup
    uses: ./.github/workflows/diff_jepsen.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      run_core: ${{ needs.DiffSetup.outputs.run_jepsen_core }}
    secrets: inherit

  Release:
    needs: DiffSetup
    uses: ./.github/workflows/diff_release.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      arch: 'amd'
      os: 'ubuntu-24.04'
      run_core: ${{ needs.DiffSetup.outputs.run_release_core }}
      run_benchmark: ${{ needs.DiffSetup.outputs.run_release_benchmark }}
      run_e2e: ${{ needs.DiffSetup.outputs.run_release_e2e }}
      run_stress: ${{ needs.DiffSetup.outputs.run_release_stress }}
      run_query_modules: ${{ needs.DiffSetup.outputs.run_release_query_modules }}
    secrets: inherit

  Malloc:
    needs: DiffSetup
    uses: ./.github/workflows/diff_malloc.yaml
    with:
      ref: ${{ inputs.ref || github.ref }}
      arch: 'amd'
      os: 'ubuntu-24.04'
      run_build: ${{ needs.DiffSetup.outputs.run_malloc_build }}
    secrets: inherit

  Mage:
    needs: DiffSetup
    uses: ./.github/workflows/diff_mage.yml
    with:
      ref: ${{ inputs.ref || github.ref }}
      os: 'ubuntu-24.04'
      run_amd: ${{ needs.DiffSetup.outputs.run_mage_amd == 'true' }}
      run_arm: ${{ needs.DiffSetup.outputs.run_mage_arm == 'true' }}
      run_cuda: ${{ needs.DiffSetup.outputs.run_mage_cuda == 'true' }}
    secrets: inherit

  DiffResult:
    if: always()
    name: "Diff Result"
    needs: [Community, Coverage, Debug, Jepsen, Release, Malloc, Mage]
    runs-on: ubuntu-latest
    steps:
      - name: Check Success/Skip Jobs
        run: |
          echo "Community: ${{ needs.Community.result }}"
          echo "Coverage: ${{ needs.Coverage.result }}"
          echo "Debug: ${{ needs.Debug.result }}"
          echo "Jepsen: ${{ needs.Jepsen.result }}"
          echo "Release: ${{ needs.Release.result }}"
          echo "Malloc: ${{ needs.Malloc.result }}"
          echo "Mage: ${{ needs.Mage.result }}"
          community=${{ needs.Community.result == 'success' || needs.Community.result == 'skipped' }}
          coverage=${{ needs.Coverage.result == 'success' || needs.Coverage.result == 'skipped' }}
          debug=${{ needs.Debug.result == 'success' || needs.Debug.result == 'skipped' }}
          jepsen=${{ needs.Jepsen.result == 'success' || needs.Jepsen.result == 'skipped' }}
          release=${{ needs.Release.result == 'success' || needs.Release.result == 'skipped' }}
          malloc=${{ needs.Malloc.result == 'success' || needs.Malloc.result == 'skipped' }}
          mage=${{ needs.Mage.result == 'success' || needs.Mage.result == 'skipped' }}

          if [ $community == false ] || [ $coverage == false ] || [ $debug == false ] || [ $jepsen == false ] || [ $release == false ] || [ $malloc == false ] || [ $mage == false ]; then
            echo "Diff workflow failed"
            exit 1
          fi

          echo "Diff workflow completed successfully"
          exit 0
